<!-- profile.wxml - å¥åº·æ¡£æ¡ˆç®¡ç† -->
<page-meta>
  <navigation-bar title="å¥åº·å®ˆæŠ¤"></navigation-bar>
</page-meta>

<!-- é¡µé¢åŠ è½½åŠ¨ç”» -->
<view class="page-loader" hidden="{{pageLoaded}}">
  <view class="loader-spinner"></view>
  <text class="loader-text">åŠ è½½ä¸­...</text>
</view>

<!-- ç¦»çº¿çŠ¶æ€æç¤º -->
<view class="offline-tip" wx:if="{{offline}}">
  å½“å‰å¤„äºç¦»çº¿çŠ¶æ€ï¼Œéƒ¨åˆ†åŠŸèƒ½å¯èƒ½å—é™
</view>

<!-- é¡¶éƒ¨çŠ¶æ€æ å ä½ -->
<view class="status-bar-placeholder"></view>

<!-- é¡µé¢å®¹å™¨ -->
<view class="page-container" wx:if="{{pageLoaded}}">
  
  <!-- é¡µé¢å†…å®¹ -->
  <view class="page-content">
  <!-- é¡¶éƒ¨å¿«æ·åŠŸèƒ½åŒº -->
  <view class="quick-actions">
    <view class="quick-action-item" bindtap="goToEmergency">
      <view class="quick-action-icon emergency-icon">ğŸš¨</view>
      <view class="quick-action-text">ç´§æ€¥å‘¼æ•‘</view>
    </view>
    <view class="quick-action-item" bindtap="goToMonitoring">
      <view class="quick-action-icon monitoring-icon">ğŸ’“</view>
      <view class="quick-action-text">å¥åº·ç›‘æµ‹</view>
    </view>
    <view class="quick-action-item" bindtap="goToServiceBooking">
      <view class="quick-action-icon service-icon">ğŸ“…</view>
      <view class="quick-action-text">æœåŠ¡é¢„çº¦</view>
    </view>
    <view class="quick-action-item" bindtap="showUserMenu">
      <view class="quick-action-icon user-menu-icon">ğŸ‘¤</view>
      <view class="quick-action-text">ç”¨æˆ·èœå•</view>
    </view>
  </view>

  <!-- ç¼–è¾‘æ¨¡å¼æŒ‰é’® -->
  <view class="edit-mode-buttons" wx:if="{{!editMode}}">
    <button 
      class="btn btn-primary btn-large font-lg font-bold"
      bindtap="enterEditMode"
    >
      ç¼–è¾‘æ¡£æ¡ˆ
    </button>
  </view>

  <!-- ä¿å­˜/å–æ¶ˆæŒ‰é’® -->
  <view class="save-cancel-buttons" wx:if="{{editMode}}">
    <button 
      class="btn btn-primary btn-large font-lg font-bold"
      bindtap="saveEdit"
      style="margin-right: 20rpx; flex: 1;"
    >
      ä¿å­˜
    </button>
    <button 
      class="btn btn-secondary btn-large font-lg font-bold"
      bindtap="cancelEdit"
      style="flex: 1;"
    >
      å–æ¶ˆ
    </button>
  </view>

  <!-- å¥åº·æ•°æ®æ¦‚è§ˆ -->
  <view class="health-overview">
    <view class="overview-title">å¥åº·æ•°æ®æ¦‚è§ˆ</view>
    <view class="overview-cards">
      <view class="overview-card">
        <view class="overview-icon blood-pressure-icon">ğŸ’‰</view>
        <view class="overview-info">
          <view class="overview-value">{{healthProfile.vitals.bloodPressure || '120/80'}}</view>
          <view class="overview-label">è¡€å‹</view>
        </view>
        <view class="overview-trend {{healthProfile.vitalsTrend && healthProfile.vitalsTrend.bloodPressure === 'up' ? 'trend-up' : 'trend-down'}}">{{healthProfile.vitalsTrend && healthProfile.vitalsTrend.bloodPressure === 'up' ? 'â†‘' : 'â†“'}}</view>
      </view>
      
      <view class="overview-card">
        <view class="overview-icon heart-rate-icon">â¤ï¸</view>
        <view class="overview-info">
          <view class="overview-value">{{healthProfile.vitals.heartRate || '72'}}</view>
          <view class="overview-label">å¿ƒç‡</view>
        </view>
        <view class="overview-trend {{healthProfile.vitalsTrend && healthProfile.vitalsTrend.heartRate === 'up' ? 'trend-up' : 'trend-down'}}">{{healthProfile.vitalsTrend && healthProfile.vitalsTrend.heartRate === 'up' ? 'â†‘' : 'â†“'}}</view>
      </view>
      
      <view class="overview-card">
        <view class="overview-icon blood-sugar-icon">ğŸ©¸</view>
        <view class="overview-info">
          <view class="overview-value">{{healthProfile.vitals.bloodSugar || '5.6'}}</view>
          <view class="overview-label">è¡€ç³–</view>
        </view>
        <view class="overview-trend {{healthProfile.vitalsTrend && healthProfile.vitalsTrend.bloodSugar === 'up' ? 'trend-up' : 'trend-down'}}">{{healthProfile.vitalsTrend && healthProfile.vitalsTrend.bloodSugar === 'up' ? 'â†‘' : 'â†“'}}</view>
      </view>
      
      <view class="overview-card">
        <view class="overview-icon weight-icon">âš–ï¸</view>
        <view class="overview-info">
          <view class="overview-value">{{healthProfile.vitals.weight || '65'}}</view>
          <view class="overview-label">ä½“é‡(kg)</view>
        </view>
        <view class="overview-trend {{healthProfile.vitalsTrend && healthProfile.vitalsTrend.weight === 'up' ? 'trend-up' : 'trend-down'}}">{{healthProfile.vitalsTrend && healthProfile.vitalsTrend.weight === 'up' ? 'â†‘' : 'â†“'}}</view>
      </view>
    </view>
    <view class="overview-note">æœ€è¿‘æ›´æ–°: {{healthProfile.lastUpdateDate || 'ä»Šå¤© 14:30'}}</view>
  </view>

  <!-- åŸºæœ¬ä¿¡æ¯ -->
  <view class="card">
    <view class="section-title font-xl font-bold text-primary">åŸºæœ¬ä¿¡æ¯</view>
    <view class="form-item">
      <view class="form-label font-lg font-medium text-primary">å§“å</view>
      <view class="form-value" wx:if="{{!editMode}}">{{healthProfile.basicInfo.name}}</view>
      <input 
        wx:else 
        class="form-input font-lg"
        value="{{tempProfile.basicInfo.name}}"
        placeholder="è¯·è¾“å…¥å§“å"
        data-field="basicInfo" 
        data-subfield="name"
        bindinput="inputChange"
      />
    </view>
    <view class="form-item">
      <view class="form-label font-lg font-medium text-primary">å¹´é¾„</view>
      <view class="form-value" wx:if="{{!editMode}}">{{healthProfile.basicInfo.age}}</view>
      <input 
        wx:else 
        class="form-input font-lg"
        value="{{tempProfile.basicInfo.age}}"
        placeholder="è¯·è¾“å…¥å¹´é¾„"
        type="number"
        data-field="basicInfo" 
        data-subfield="age"
        bindinput="inputChange"
      />
    </view>
    <view class="form-item">
      <view class="form-label font-lg font-medium text-primary">æ€§åˆ«</view>
      <view class="form-value" wx:if="{{!editMode}}">{{healthProfile.basicInfo.gender}}</view>
      <input 
        wx:else 
        class="form-input font-lg"
        value="{{tempProfile.basicInfo.gender}}"
        placeholder="è¯·è¾“å…¥æ€§åˆ«"
        data-field="basicInfo" 
        data-subfield="gender"
        bindinput="inputChange"
      />
    </view>
    <view class="form-item">
      <view class="form-label font-lg font-medium text-primary">è”ç³»ç”µè¯</view>
      <view class="form-value" wx:if="{{!editMode}}">{{healthProfile.basicInfo.phone}}</view>
      <input 
        wx:else 
        class="form-input font-lg"
        value="{{tempProfile.basicInfo.phone}}"
        placeholder="è¯·è¾“å…¥è”ç³»ç”µè¯"
        type="number"
        data-field="basicInfo" 
        data-subfield="phone"
        bindinput="inputChange"
      />
    </view>
    <view class="form-item">
      <view class="form-label font-lg font-medium text-primary">å±…ä½åœ°å€</view>
      <view class="form-value" wx:if="{{!editMode}}">{{healthProfile.basicInfo.address}}</view>
      <input 
        wx:else 
        class="form-input font-lg"
        value="{{tempProfile.basicInfo.address}}"
        placeholder="è¯·è¾“å…¥å±…ä½åœ°å€"
        data-field="basicInfo" 
        data-subfield="address"
        bindinput="inputChange"
      />
    </view>
  </view>

  <!-- æ…¢æ€§ç—…è®°å½• -->
  <view class="card">
    <view class="section-title font-xl font-bold text-primary">æ…¢æ€§ç—…è®°å½•</view>
    <view wx:if="{{healthProfile.chronicDiseases.length === 0}}">
      <view class="empty-text font-lg text-secondary">æš‚æ— æ…¢æ€§ç—…è®°å½•</view>
    </view>
    <view wx:else>
      <view 
        wx:for="{{healthProfile.chronicDiseases}}" 
        wx:key="id"
        class="disease-item"
      >
        <view class="disease-name font-lg font-medium text-primary">{{item.name}}</view>
        <view class="disease-detail font-sm text-secondary">
          ç¡®è¯Šæ—¥æœŸï¼š{{item.diagnosisDate}} | çŠ¶æ€ï¼š{{item.status}}
        </view>
      </view>
    </view>
    <!-- ç¼–è¾‘æ¨¡å¼ä¸‹çš„æ…¢æ€§ç—…ç®¡ç† -->
    <view wx:if="{{editMode}}">
      <view wx:for="{{tempProfile.chronicDiseases}}" wx:key="id" class="disease-edit-item">
        <view class="disease-edit-form">
          <input 
            class="form-input font-lg"
            value="{{item.name}}"
            placeholder="ç–¾ç—…åç§°"
            data-index="{{index}}" 
            data-field="name"
            bindinput="chronicDiseaseChange"
            style="margin-bottom: 20rpx;"
          />
          <input 
            class="form-input font-lg"
            value="{{item.diagnosisDate}}"
            placeholder="ç¡®è¯Šæ—¥æœŸï¼ˆYYYY-MM-DDï¼‰"
            data-index="{{index}}" 
            data-field="diagnosisDate"
            bindinput="chronicDiseaseChange"
            style="margin-bottom: 20rpx;"
          />
          <input 
            class="form-input font-lg"
            value="{{item.status}}"
            placeholder="çŠ¶æ€ï¼ˆå¦‚ï¼šç¨³å®šã€ä¸ç¨³å®šï¼‰"
            data-index="{{index}}" 
            data-field="status"
            bindinput="chronicDiseaseChange"
          />
        </view>
        <button 
          class="btn btn-danger" 
          bindtap="deleteChronicDisease"
          data-index="{{index}}"
        >
          åˆ é™¤
        </button>
      </view>
      <button 
        class="btn btn-secondary btn-large font-lg font-bold"
        bindtap="addChronicDisease"
        style="margin-top: 20rpx;"
      >
        æ·»åŠ æ…¢æ€§ç—…
      </button>
    </view>
  </view>

  <!-- ç”¨è¯è®°å½• -->
  <view class="card">
    <view class="section-title font-xl font-bold text-primary">ç”¨è¯è®°å½•</view>
    <view wx:if="{{healthProfile.medication.length === 0}}">
      <view class="empty-text font-lg text-secondary">æš‚æ— ç”¨è¯è®°å½•</view>
    </view>
    <view wx:else>
      <view 
        wx:for="{{healthProfile.medication}}" 
        wx:key="id"
        class="medication-item"
      >
        <view class="medication-name font-lg font-medium text-primary">{{item.name}}</view>
        <view class="medication-detail font-sm text-secondary">
           å‰‚é‡ï¼š{{item.dosage}} | æœç”¨æ—¶é—´ï¼š{{item.time}}
        </view>
      </view>
    </view>
    <!-- ç¼–è¾‘æ¨¡å¼ä¸‹çš„ç”¨è¯ç®¡ç† -->
    <view wx:if="{{editMode}}">
      <view wx:for="{{tempProfile.medication}}" wx:key="id" class="medication-edit-item">
        <view class="medication-edit-form">
          <input 
            class="form-input font-lg"
            value="{{item.name}}"
            placeholder="è¯ç‰©åç§°"
            data-index="{{index}}" 
            data-field="name"
            bindinput="medicationChange"
            style="margin-bottom: 20rpx;"
          />
          <input 
            class="form-input font-lg"
            value="{{item.dosage}}"
            placeholder="å‰‚é‡ï¼ˆå¦‚ï¼š1ç‰‡/æ¬¡ï¼Œ2æ¬¡/æ—¥ï¼‰"
            data-index="{{index}}" 
            data-field="dosage"
            bindinput="medicationChange"
            style="margin-bottom: 20rpx;"
          />
          <input 
            class="form-input font-lg"
            value="{{item.time}}"
            placeholder="æœç”¨æ—¶é—´ï¼ˆå¦‚ï¼šæ—©7:00ï¼Œæ™š7:00ï¼‰"
            data-index="{{index}}" 
            data-field="time"
            bindinput="medicationChange"
          />
        </view>
        <button 
          class="btn btn-danger" 
          bindtap="deleteMedication"
          data-index="{{index}}"
        >
          åˆ é™¤
        </button>
      </view>
      <button 
        class="btn btn-secondary btn-large font-lg font-bold"
        bindtap="addMedication"
        style="margin-top: 20rpx;"
      >
        æ·»åŠ ç”¨è¯
      </button>
    </view>
  </view>

  <!-- è¿‡æ•å² -->
  <view class="card">
    <view class="section-title font-xl font-bold text-primary">è¿‡æ•å²</view>
    <view class="form-item">
      <view class="form-label font-lg font-medium text-primary">è¿‡æ•è¯ç‰©/é£Ÿç‰©</view>
      <view class="form-value" wx:if="{{!editMode}}">{{healthProfile.allergies || 'æ— '}}</view>
      <input 
        wx:else 
        class="form-input font-lg"
        value="{{tempProfile.allergies}}"
        placeholder="è¯·è¾“å…¥è¿‡æ•è¯ç‰©/é£Ÿç‰©ï¼Œæ— åˆ™è¾“å…¥æ— "
        data-field="allergies"
        bindinput="inputChange"
      />
    </view>
  </view>

  <!-- å°±åŒ»è®°å½• -->
  <view class="card">
    <view class="section-title font-xl font-bold text-primary">å°±åŒ»è®°å½•</view>
    <view wx:if="{{healthProfile.medicalHistory.length === 0}}">
      <view class="empty-text font-lg text-secondary">æš‚æ— å°±åŒ»è®°å½•</view>
    </view>
    <view wx:else>
      <view 
        wx:for="{{healthProfile.medicalHistory}}" 
        wx:key="id"
        class="medical-item"
        bindtap="viewMedicalDetail"
        data-id="{{item.id}}"
      >
        <view class="medical-date">{{item.date}}</view>
        <view class="medical-hospital">{{item.hospital}}</view>
        <view class="medical-diagnosis">{{item.diagnosis}}</view>
        <view class="medical-arrow">></view>
      </view>
    </view>
    <view class="view-more" bindtap="goToMedicalHistory" wx:if="{{healthProfile.medicalHistory.length > 0}}">
      æŸ¥çœ‹å…¨éƒ¨å°±åŒ»è®°å½•
    </view>
  </view>

  <!-- å¥åº·æŒ‡æ ‡è¶‹åŠ¿ -->
  <view class="card">
    <view class="section-title font-xl font-bold text-primary">å¥åº·æŒ‡æ ‡è¶‹åŠ¿</view>
    <view class="chart-container">
      <canvas canvas-id="healthChart" class="health-chart"></canvas>
    </view>
    <view class="chart-legend">
      <view class="legend-item">
        <view class="legend-color blood-pressure-color"></view>
        <view class="legend-text">è¡€å‹</view>
      </view>
      <view class="legend-item">
        <view class="legend-color heart-rate-color"></view>
        <view class="legend-text">å¿ƒç‡</view>
      </view>
      <view class="legend-item">
        <view class="legend-color blood-sugar-color"></view>
        <view class="legend-text">è¡€ç³–</view>
      </view>
    </view>
  </view>
  </view>
</view>
